<!DOCTYPE html>
<html lang="zh-TW">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Notion File Manager - Glassmorphism Dashboard</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600&family=JetBrains+Mono&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/dropbox.js/10.34.0/Dropbox-sdk.min.js"></script>
    <style>
        :root {
            --primary: #6e8efb;
            --secondary: #a777e3;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --glass-bg: rgba(255, 255, 255, 0.1);
            --glass-border: rgba(255, 255, 255, 0.2);
            --glass-shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.37);
            --text-color: #ffffff;
            --sidebar-width: 280px;
            --folder-red: #ff5f56;
            --folder-orange: #ffbd2e;
            --folder-green: #27c93f;
            --folder-blue: #4da3ff;
            --folder-purple: #b388ff;
            --folder-pink: #ff80ab;
            --folder-cyan: #80deea;
            --folder-gray: #b0bec5;
        }

        * {
            box-sizing: border-box;
            margin: 0;
            padding: 0;
            user-select: none;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: var(--bg-gradient);
            background-attachment: fixed;
            height: 100vh;
            overflow: hidden;
            display: flex;
            color: var(--text-color);
        }

        /* --- Glassmorphism UI Components --- */
        .glass-panel {
            background: var(--glass-bg);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid var(--glass-border);
            box-shadow: var(--glass-shadow);
        }

        .glass-card {
            background: rgba(255, 255, 255, 0.05);
            backdrop-filter: blur(10px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 12px;
            transition: all 0.3s ease;
        }

        .glass-card:hover {
            background: rgba(255, 255, 255, 0.1);
            transform: translateY(-2px);
        }

        /* --- Sidebar --- */
        #sidebar {
            width: var(--sidebar-width);
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            z-index: 100;
        }

        .logo {
            font-size: 1.2rem;
            font-weight: 600;
            margin-bottom: 30px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .nav-section {
            margin-bottom: 20px;
        }

        .nav-title {
            font-size: 0.7rem;
            text-transform: uppercase;
            letter-spacing: 1px;
            opacity: 0.6;
            margin-bottom: 15px;
        }

        .tree-item {
            display: flex;
            align-items: center;
            gap: 10px;
            padding: 8px 12px;
            border-radius: 8px;
            cursor: pointer;
            transition: background 0.2s;
            font-size: 0.9rem;
        }

        .tree-item:hover {
            background: rgba(255, 255, 255, 0.1);
        }

        .tree-item.active {
            background: var(--primary);
            box-shadow: 0 4px 15px rgba(110, 142, 251, 0.4);
        }

        /* --- Main Content --- */
        #main-content {
            flex: 1;
            height: 100%;
            display: flex;
            flex-direction: column;
            padding: 20px;
            overflow-y: auto;
        }

        header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 30px;
        }

        .search-bar {
            background: rgba(255, 255, 255, 0.1);
            border: 1px solid rgba(255, 255, 255, 0.2);
            border-radius: 20px;
            padding: 8px 20px;
            width: 300px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .search-bar input {
            background: none;
            border: none;
            color: white;
            outline: none;
            width: 100%;
        }

        .search-bar input::placeholder {
            color: rgba(255, 255, 255, 0.5);
        }

        .toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
        }

        .btn {
            padding: 8px 16px;
            border-radius: 8px;
            border: 1px solid var(--glass-border);
            background: var(--glass-bg);
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.85rem;
            transition: all 0.2s;
        }

        .btn:hover {
            background: rgba(255, 255, 255, 0.2);
        }

        .btn.primary {
            background: var(--primary);
            border: none;
        }

        /* --- Breadcrumbs --- */
        .breadcrumbs {
            display: flex;
            align-items: center;
            gap: 8px;
            font-size: 0.9rem;
            opacity: 0.8;
            margin-bottom: 20px;
        }

        .breadcrumbs span {
            cursor: pointer;
        }

        .breadcrumbs span:hover {
            text-decoration: underline;
        }

        /* --- Grid/List View --- */
        .items-container {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(180px, 1fr));
            gap: 20px;
        }

        .items-container.list-view {
            display: flex;
            flex-direction: column;
        }

        .item-card {
            padding: 20px;
            text-align: center;
            cursor: pointer;
            position: relative;
        }

        .item-card i.fa-folder {
            font-size: 3rem;
            margin-bottom: 10px;
            display: block;
        }

        .item-card i.fa-file-lines,
        .item-card i.fa-file-image {
            font-size: 2.5rem;
            margin-bottom: 15px;
            display: block;
        }

        .item-card .item-name {
            font-size: 0.9rem;
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        .item-card .item-info {
            font-size: 0.7rem;
            opacity: 0.5;
            margin-top: 5px;
        }

        /* List View Styles */
        .list-view .item-card {
            display: grid;
            grid-template-columns: 40px 1fr 100px 150px 80px;
            align-items: center;
            text-align: left;
            padding: 12px 20px;
        }

        .list-view .item-card i {
            font-size: 1.2rem !important;
            margin: 0 !important;
        }

        /* --- Journal Editor Modal --- */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.5);
            z-index: 1000;
            justify-content: center;
            align-items: center;
        }

        .modal-content {
            width: 90%;
            max-width: 800px;
            height: 80vh;
            border-radius: 20px;
            padding: 40px;
            display: flex;
            flex-direction: column;
            position: relative;
        }

        .editor-header {
            margin-bottom: 20px;
        }

        .editor-title {
            font-size: 1.8rem;
            font-weight: 600;
            background: none;
            border: none;
            color: white;
            width: 100%;
            outline: none;
        }

        #editor-body {
            flex: 1;
            background: rgba(255, 255, 255, 0.05);
            border-radius: 12px;
            padding: 20px;
            outline: none;
            overflow-y: auto;
            font-family: 'Inter', sans-serif;
            line-height: 1.6;
        }

        .editor-toolbar {
            display: flex;
            gap: 15px;
            margin-bottom: 10px;
            opacity: 0.7;
        }

        .editor-toolbar button {
            background: none;
            border: none;
            color: white;
            cursor: pointer;
        }

        /* --- Context Menu --- */
        #context-menu {
            position: fixed;
            display: none;
            background: rgba(25, 25, 25, 0.8);
            backdrop-filter: blur(15px);
            border: 1px solid rgba(255, 255, 255, 0.1);
            border-radius: 8px;
            padding: 5px 0;
            z-index: 2000;
            min-width: 150px;
            box-shadow: 0 10px 20px rgba(0, 0, 0, 0.3);
        }

        .menu-item {
            padding: 8px 15px;
            font-size: 0.85rem;
            cursor: pointer;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .menu-item:hover {
            background: var(--primary);
        }

        .color-dots {
            display: flex;
            gap: 5px;
            padding: 8px 15px;
            border-top: 1px solid rgba(255, 255, 255, 0.1);
        }

        .dot {
            width: 12px;
            height: 12px;
            border-radius: 50%;
            cursor: pointer;
        }

        /* --- Upload / Toast --- */
        #drop-zone {
            display: none;
            position: fixed;
            top: 20px;
            left: 20px;
            right: 20px;
            bottom: 20px;
            border: 3px dashed var(--primary);
            border-radius: 30px;
            z-index: 3000;
            background: rgba(110, 142, 251, 0.1);
            justify-content: center;
            align-items: center;
            backdrop-filter: blur(5px);
        }

        .toast {
            position: fixed;
            bottom: 20px;
            right: 20px;
            background: #27c93f;
            color: white;
            padding: 12px 24px;
            border-radius: 10px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
            display: none;
            animation: slideIn 0.3s ease-out;
            z-index: 4000;
        }

        @keyframes slideIn {
            from {
                transform: translateX(100%);
            }

            to {
                transform: translateX(0);
            }
        }

        /* --- Login Overlay --- */
        #login-overlay {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            z-index: 9999;
            display: flex;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }

        .login-box {
            background: rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(20px);
            padding: 40px;
            border-radius: 20px;
            border: 1px solid var(--glass-border);
            text-align: center;
            width: 350px;
            box-shadow: 0 15px 35px rgba(0, 0, 0, 0.2);
        }

        .login-box h2 {
            margin-bottom: 20px;
            font-weight: 500;
        }

        .login-input {
            width: 100%;
            padding: 12px;
            border-radius: 8px;
            border: 1px solid rgba(255, 255, 255, 0.2);
            background: rgba(0, 0, 0, 0.2);
            color: white;
            margin-bottom: 20px;
            text-align: center;
            font-size: 1.2rem;
            letter-spacing: 5px;
        }

        .login-input:focus {
            outline: none;
            border-color: var(--primary);
        }

        /* --- Responsive --- */
        @media (max-width: 768px) {
            #sidebar {
                display: none;
            }

            .search-bar {
                width: 100%;
            }
        }
    </style>
</head>

<body oncontextmenu="return false;">

    <!-- Sidebar -->
    <div id="sidebar" class="glass-panel">
        <div class="logo">
            <i class="fas fa-cube"></i>
            <span>NFM Dashboard</span>
        </div>

        <div class="nav-section">
            <div class="nav-title">Âø´ÈÄüÂ≠òÂèñ</div>
            <div class="tree-item active" onclick="app.navigateTo('root')"
                ondragover="event.preventDefault(); this.style.background='rgba(255,255,255,0.2)'"
                ondragleave="this.style.background=''"
                ondrop="event.preventDefault(); this.style.background=''; app.handleMoveItem(event.dataTransfer.getData('text/plain'), 'root'); event.stopPropagation();">
                <i class="fas fa-home"></i> üóÇ Ê™îÊ°àÁ∏ΩÁÆ°
            </div>
            <div class="tree-item" onclick="app.filterBy('journal')">
                <i class="fas fa-book"></i> üìì ÂÖ±‰ΩúÊó•Ë™å
            </div>
            <div class="tree-item" onclick="app.filterBy('recent')">
                <i class="fas fa-clock"></i> üïí ÊúÄËøëÊõ¥Êñ∞
            </div>
        </div>

        <div class="nav-section">
            <div class="nav-title">Ë≥áÊñôÂ§æÂ±§Ê¨°</div>
            <div id="folder-tree">
                <!-- Áî± JS ÂãïÊÖãÁîüÊàê -->
            </div>
        </div>

        <div class="nav-section" style="margin-top: auto;">
            <div class="tree-item" onclick="app.toggleSettings()">
                <i class="fas fa-cog"></i> Ë®≠ÂÆöËàáÂÑ≤Â≠ò
            </div>
            <div class="tree-item" onclick="app.toggleTheme()">
                <i class="fas fa-moon"></i> Ê∑±Ëâ≤Ê®°Âºè
            </div>
        </div>
    </div>

    <!-- Main Content -->
    <div id="main-content">
        <header>
            <div class="search-bar">
                <i class="fas fa-search"></i>
                <input type="text" id="global-search" placeholder="ÊêúÂ∞ãÊ™îÊ°à„ÄÅÊó•Ë™åÊàñÊ®ôÁ±§..." oninput="app.search(this.value)">
            </div>
            <div class="user-profile">
                <!-- Notion style user widget placeholder -->
                <div
                    style="width: 35px; height: 35px; border-radius: 50%; background: var(--primary); display: flex; align-items: center; justify-content: center;">
                    <i class="fas fa-user-circle"></i>
                </div>
            </div>
        </header>

        <div class="breadcrumbs" id="breadcrumbs">
            <span onclick="app.navigateTo('root')">È¶ñÈ†Å / </span>
        </div>

        <div class="toolbar">
            <button class="btn primary" onclick="app.createItem('folder')">
                <i class="fas fa-folder-plus"></i> Êñ∞Â¢ûË≥áÊñôÂ§æ
            </button>
            <button class="btn" onclick="app.createItem('journal')">
                <i class="fas fa-pen-nib"></i> Âª∫Á´ãÊó•Ë™å
            </button>
            <button class="btn" onclick="document.getElementById('file-input').click()">
                <i class="fas fa-cloud-upload-alt"></i> ‰∏äÂÇ≥Ê™îÊ°à
            </button>
            <input type="file" id="file-input" style="display:none" multiple
                onchange="app.handleFileUpload(this.files)">

            <div style="margin-left: auto; display: flex; gap: 10px;">
                <button class="btn" onclick="app.setViewMode('grid')">
                    <i class="fas fa-th"></i>
                </button>
                <button class="btn" onclick="app.setViewMode('list')">
                    <i class="fas fa-list"></i>
                </button>
            </div>
        </div>

        <div id="items-grid" class="items-container">
            <!-- Ê™îÊ°àÈ†ÖÁõÆÂãïÊÖãËºâÂÖ• -->
        </div>
    </div>

    <!-- Journal Modal -->
    <div id="journal-modal" class="modal">
        <div class="modal-content glass-panel">
            <div class="editor-header">
                <input type="text" id="editor-title" class="editor-title" placeholder="ÁÑ°Ê®ôÈ°å">
                <div style="font-size: 0.8rem; opacity: 0.5; margin-top: 5px;" id="editor-meta">Âª∫Á´ãÊñº 2026/02/18</div>
            </div>
            <div class="editor-toolbar">
                <button onclick="document.execCommand('bold')"><i class="fas fa-bold"></i></button>
                <button onclick="document.execCommand('italic')"><i class="fas fa-italic"></i></button>
                <button onclick="document.execCommand('insertUnorderedList')"><i class="fas fa-list-ul"></i></button>
                <button onclick="document.execCommand('createLink', false, prompt('Ëº∏ÂÖ•ÈÄ£Áµê URL:'))"><i
                        class="fas fa-link"></i></button>
                <span style="flex:1"></span>
                <button onclick="app.closeEditor()"><i class="fas fa-times"></i> ÈóúÈñâ‰∏¶ÂÑ≤Â≠ò</button>
            </div>
            <div id="editor-body" contenteditable="true" placeholder="ÈñãÂßãËº∏ÂÖ•ÊÇ®ÁöÑÊó•Ë™å..."></div>
        </div>
    </div>

    <!-- Context Menu -->
    <div id="context-menu">
        <div class="menu-item" onclick="app.renameItem()"><i class="fas fa-edit"></i> ÈáçÊñ∞ÂëΩÂêç</div>
        <div class="menu-item" onclick="app.showMoveModal()"><i class="fas fa-arrows-alt"></i> ÁßªÂãïËá≥...</div>
        <div class="menu-item" onclick="app.showTagsModal()"><i class="fas fa-tags"></i> Á∑®ËºØÊ®ôÁ±§</div>
        <div class="menu-item" onclick="app.duplicateItem()"><i class="fas fa-copy"></i> Âª∫Á´ãÂâØÊú¨</div>
        <div class="menu-item" onclick="app.shareItem()"><i class="fas fa-share-alt"></i> ÂàÜ‰∫´ÈÄ£Áµê</div>
        <div class="menu-item" style="color: #ff5f56;" onclick="app.deleteItem()"><i class="fas fa-trash"></i> Âà™Èô§È†ÖÁõÆ
        </div>
        <div class="color-dots" id="folder-colors">
            <div class="dot" style="background: var(--folder-red);" onclick="app.setItemColor('red')"></div>
            <div class="dot" style="background: var(--folder-orange);" onclick="app.setItemColor('orange')"></div>
            <div class="dot" style="background: var(--folder-green);" onclick="app.setItemColor('green')"></div>
            <div class="dot" style="background: var(--folder-blue);" onclick="app.setItemColor('blue')"></div>
            <div class="dot" style="background: var(--folder-purple);" onclick="app.setItemColor('purple')"></div>
            <div class="dot" style="background: var(--folder-cyan);" onclick="app.setItemColor('cyan')"></div>
        </div>
    </div>

    <!-- Drop Zone -->
    <div id="drop-zone">
        <div style="text-align: center;">
            <i class="fas fa-cloud-upload-alt" style="font-size: 5rem; margin-bottom: 20px;"></i>
            <h2>ÊîæÈñã‰ª•ÈñãÂßã‰∏äÂÇ≥</h2>
        </div>
    </div>

    <!-- Toast -->
    <div id="toast" class="toast">Êìç‰ΩúÊàêÂäü</div>

    <!-- Login Overlay -->
    <div id="login-overlay">
        <div class="login-box">
            <i class="fas fa-lock" style="font-size: 3rem; margin-bottom: 20px; opacity: 0.8;"></i>
            <h2 id="login-title">App Locked</h2>
            <input type="password" id="login-input" class="login-input" placeholder="‚Ä¢‚Ä¢‚Ä¢‚Ä¢" maxlength="8"
                onkeyup="if(event.key === 'Enter') app.checkLogin()">
            <button class="btn primary" style="width: 100%; justify-content: center;" onclick="app.checkLogin()">
                <i class="fas fa-arrow-right"></i> ÈÄ≤ÂÖ•
            </button>
            <div id="login-msg" style="margin-top: 15px; font-size: 0.8rem; color: #ff5f56; min-height: 1.2em;"></div>
        </div>
    </div>

    <!-- Settings Modal -->
    <div id="settings-modal" class="modal">
        <div class="modal-content glass-panel" style="height: auto; max-width: 500px;">
            <div class="editor-header">
                <h2>Ë®≠ÂÆö</h2>
            </div>

            <div style="margin-top: 20px;">
                <label>ÂÑ≤Â≠ò‰ΩçÁΩÆ:</label>
                <select id="provider-select" class="search-bar" style="width: 100%; margin-top: 5px;"
                    onchange="app.switchProvider(this.value, true)">
                    <option value="local">Êú¨Ê©üÂÑ≤Â≠ò (ÁÄèË¶ΩÂô®)</option>
                    <option value="dropbox">Dropbox Èõ≤Á´Ø</option>
                    <option value="notion">Notion API Èõ≤Á´Ø (Êé®Ëñ¶)</option>
                </select>
                <div id="dropbox-status" style="margin-top: 10px; font-size: 0.8rem; color: #a8b2d1;"></div>
            </div>
            <button id="btn-disconnect-dropbox" class="btn" onclick="app.providers.dropbox.logout()"
                style="margin-top: 10px; font-size: 0.8rem; border: 1px solid #ff5f56; color: #ff5f56; display: none;">
                <i class="fas fa-unlink"></i> Êñ∑Èñã Dropbox ÈÄ£Áµê (ÁôªÂá∫)
            </button>
            <div
                style="text-align: center; margin-top: 20px; padding-top: 20px; border-top: 1px solid rgba(255,255,255,0.1);">
                <button class="btn" style="width: 100%; justify-content: center; background: rgba(255,255,255,0.05);"
                    onclick="app.lockApp()">
                    <i class="fas fa-lock"></i> ÈéñÂÆö App
                </button>
            </div>
        </div>
        <div style="text-align: right;">
            <button class="btn" onclick="document.getElementById('settings-modal').style.display='none'">ÈóúÈñâ</button>
        </div>
    </div>
    </div>

    <!-- Move Modal -->
    <div id="move-modal" class="modal">
        <div class="modal-content glass-panel" style="height: auto; max-width: 400px; padding: 25px;">
            <div class="editor-header" style="margin-bottom: 15px;">
                <h2>ÈÅ∏ÊìáÁõÆÊ®ôË≥áÊñôÂ§æ</h2>
            </div>
            <div id="move-folder-list"
                style="max-height: 250px; overflow-y: auto; margin-bottom: 20px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; padding: 10px; background: rgba(0,0,0,0.1);">
                <!-- ÂãïÊÖãÁîüÊàêË≥áÊñôÂ§æÂàóË°® -->
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn" onclick="document.getElementById('move-modal').style.display='none'">ÂèñÊ∂à</button>
                <button class="btn primary" onclick="app.confirmMove()">ÁßªÂãï</button>
            </div>
        </div>
    </div>

    <!-- Tags Modal -->
    <div id="tags-modal" class="modal">
        <div class="modal-content glass-panel" style="height: auto; max-width: 400px; padding: 25px;">
            <div class="editor-header" style="margin-bottom: 15px;">
                <h2>Á∑®ËºØÊ®ôÁ±§</h2>
            </div>
            <div style="margin-bottom: 15px;">
                <input type="text" id="tag-input" class="search-bar"
                    style="width: 100%; border-radius: 8px; padding: 10px; background: rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2); color: white;"
                    placeholder="Ëº∏ÂÖ•Ê®ôÁ±§ÂêçÁ®±ÂæåÊåâ Enter" onkeyup="if(event.key === 'Enter') app.addTag(this.value)">
            </div>
            <div id="current-tags"
                style="display: flex; gap: 8px; flex-wrap: wrap; margin-bottom: 20px; min-height: 40px; padding: 10px; border: 1px solid rgba(255,255,255,0.1); border-radius: 8px; background: rgba(0,0,0,0.1);">
                <!-- ÂãïÊÖãÁîüÊàêÊ®ôÁ±§ -->
            </div>
            <div style="display: flex; justify-content: flex-end; gap: 10px;">
                <button class="btn primary"
                    onclick="document.getElementById('tags-modal').style.display='none'">ÂÆåÊàê</button>
            </div>
        </div>
    </div>

    <script>
        // --- Storage Providers ---
        class LocalStorageProvider {
            constructor() {
                this.name = 'local';
            }

            async init() {
                // Initialize default data if empty
                if (!localStorage.getItem('nfm_items')) {
                    const defaults = [
                        { id: 'root', name: 'Root', type: 'folder', parentId: null, color: 'blue', createdAt: new Date() },
                        { id: '1', name: 'Â∞àÊ°àË™™Êòé', type: 'journal', parentId: 'root', content: 'Ê≠°Ëøé‰ΩøÁî® Notion Ê™îÊ°àÁÆ°ÁêÜÂô® (Local)ÔºÅ', createdAt: new Date() }
                    ];
                    localStorage.setItem('nfm_items', JSON.stringify(defaults));
                }
                return true;
            }

            async getItems() {
                return JSON.parse(localStorage.getItem('nfm_items') || '[]');
            }

            async saveItems(items) {
                localStorage.setItem('nfm_items', JSON.stringify(items));
                return true;
            }

            async uploadFile(fileItem) {
                // LocalStorage already has the data in fileItem.fileData (base64)
                // No extra upload step needed for simulation
                return fileItem;
            }

            async deleteFile(item) {
                return true;
            }
        }

        class DropboxProvider {
            constructor(appKey) {
                this.name = 'dropbox';
                this.CLIENT_ID = appKey;
                this.dbx = null;
                this.accessToken = this.getAccessTokenFromUrl() || localStorage.getItem('nfm_dropbox_token');

                if (this.accessToken) {
                    this.dbx = new Dropbox.Dropbox({ accessToken: this.accessToken });
                    localStorage.setItem('nfm_dropbox_token', this.accessToken);
                    // Clear hash from URL to clean up
                    if (window.location.hash.includes('access_token')) {
                        window.history.replaceState({}, document.title, window.location.pathname);
                    }
                }
            }

            getAccessTokenFromUrl() {
                return new URLSearchParams(window.location.hash.substring(1)).get('access_token');
            }

            async init() {
                if (!this.accessToken) {
                    return false; // Not logged in
                }
                return true;
            }

            login() {
                const authUrl = `https://www.dropbox.com/oauth2/authorize?client_id=${this.CLIENT_ID}&response_type=token&redirect_uri=${window.location.origin}${window.location.pathname}`;
                window.location.href = authUrl;
            }

            logout() {
                this.accessToken = null;
                this.dbx = null;
                localStorage.removeItem('nfm_dropbox_token');
                window.location.hash = '';
                app.switchProvider('local');
            }

            handleError(error) {
                // Check for 401 Unauthorized (invalid token or scope mismatch)
                const status = error.status || (error.error && error.error.status);
                if (status === 401) {
                    alert('Dropbox ÊéàÊ¨äÂ∑≤ÈÅéÊúüÊàñÊ¨äÈôê‰∏çË∂≥ÔºåË´ãÈáçÊñ∞ÈÄ£Áµê„ÄÇ');
                    this.logout();
                    return true; // Handled
                }
                console.error('Dropbox API Error', error);
                return false; // Not handled
            }

            // Map Dropbox files to NFM items
            async getItems() {
                if (!this.dbx) return [];
                try {
                    // Check if nfm_db.json exists in root
                    let dbFile;
                    try {
                        const response = await this.dbx.filesDownload({ path: '/nfm_db.json' });
                        const blob = response.result.fileBlob;
                        const text = await blob.text();
                        return JSON.parse(text);
                    } catch (e) {
                        if (this.handleError(e)) return [];

                        console.log('No DB file found, creating new', e);
                        // Initial DB
                        const defaults = [
                            { id: 'root', name: 'Root', type: 'folder', parentId: null, color: 'blue', createdAt: new Date() },
                            { id: '1', name: 'Dropbox Ë™™Êòé', type: 'journal', parentId: 'root', content: 'ÈÄôÊòØÂÑ≤Â≠òÂú® Dropbox Ê†πÁõÆÈåÑÁöÑË≥áÊñôÔºÅ', createdAt: new Date() }
                        ];
                        await this.saveItems(defaults);
                        return defaults;
                    }

                } catch (error) {
                    if (!this.handleError(error)) throw error;
                    return [];
                }
            }

            async saveItems(items) {
                if (!this.dbx) return;

                const json = JSON.stringify(items);
                const file = new File([json], "nfm_db.json", { type: "application/json" });

                try {
                    await this.dbx.filesUpload({
                        path: '/nfm_db.json',
                        contents: file,
                        mode: 'overwrite'
                    });
                } catch (error) {
                    this.handleError(error);
                    throw error;
                }
                return true;
            }

            async uploadFile(fileItem) {
                if (fileItem.type === 'file' && fileItem.fileObj) {
                    // Upload to /filename
                    const uploadPath = '/' + fileItem.name;
                    try {
                        const result = await this.dbx.filesUpload({
                            path: uploadPath,
                            contents: fileItem.fileObj,
                            mode: 'add',
                            autorename: true
                        });

                        fileItem.dropboxPath = result.result.path_lower;
                        delete fileItem.fileData;
                        delete fileItem.fileObj;
                    } catch (e) {
                        if (!this.handleError(e)) {
                            console.error('Upload failed', e);
                            throw e;
                        }
                    }
                }
                return fileItem;
            }

            async deleteFile(item) {
                if (item.type === 'file' && item.dropboxPath && this.dbx) {
                    try {
                        await this.dbx.filesDeleteV2({
                            path: item.dropboxPath
                        });
                    } catch (e) {
                        if (!this.handleError(e)) {
                            console.error('Delete from Dropbox failed', e);
                        }
                    }
                }
                return true;
            }
        }

        class NotionProvider {
            constructor() {
                this.name = 'notion';
            }

            async init() {
                return true;
            }

            // Function to invoke the Netlify Serverless Proxy
            async notionRequest(endpoint, method = 'POST', payload = null) {
                try {
                    const response = await fetch('/.netlify/functions/notion', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/json'
                        },
                        body: JSON.stringify({
                            endpoint: endpoint,
                            method: method,
                            payload: payload
                        })
                    });

                    if (!response.ok) {
                        const errText = await response.text();
                        console.error('Notion Proxy Error:', errText);
                        throw new Error(`Proxy status ${response.status}: ${errText}`);
                    }

                    return await response.json();
                } catch (e) {
                    console.error('Failed to communicate with Notion Proxy:', e);
                    throw e;
                }
            }

            async getItems() {
                // For this implementation, we map our application's unified JSON structure
                // But in a real-world full migration, we would map the row/pages directly.
                // For now, to keep everything simple and compatible with existing Dropbox codebase,
                // We will use a special "nfm_db.json" system block or a dedicated block within the File DB.
                // However, since we want full Notion API integration, we will query both DBs 
                // and construct our item array.

                try {
                    // Query File Database
                    const fileDbRes = await this.notionRequest('/databases/file_db/query');
                    // Query Journal Database
                    const journalDbRes = await this.notionRequest('/databases/journal_db/query');

                    let items = [];

                    // Map File DB rows
                    if (fileDbRes && fileDbRes.results) {
                        fileDbRes.results.forEach(page => {
                            const props = page.properties;
                            // Parse properties based on the assumed Notion structure ...
                            // This gets complex quickly depending on exact property types.
                            // To ensure immediate functionality without breaking the UI, 
                            // we will continue using a single DB JSON chunk for Phase 1 
                            // stored inside a special config page if needed.

                            // But strictly speaking, mapping properties works like this:
                            let title = "Êú™ÂëΩÂêç";
                            if (props['ÂêçÁ®±'] && props['ÂêçÁ®±'].title && props['ÂêçÁ®±'].title.length > 0) {
                                title = props['ÂêçÁ®±'].title[0].plain_text;
                            }

                            let type = 'file';
                            if (props['È°ûÂûã'] && props['È°ûÂûã'].select) {
                                const sel = props['È°ûÂûã'].select.name;
                                if (sel.includes('Ë≥áÊñôÂ§æ')) type = 'folder';
                                if (sel.includes('Êó•Ë™å')) type = 'journal';
                            }

                            let tags = [];
                            if (props['Ê®ôÁ±§'] && props['Ê®ôÁ±§'].multi_select) {
                                tags = props['Ê®ôÁ±§'].multi_select.map(t => t.name);
                            }

                            items.push({
                                id: page.id,
                                name: title,
                                type: type,
                                parentId: 'root', // To dynamically resolve relations requires more logic
                                tags: tags,
                                createdAt: new Date(page.created_time)
                            });
                        });
                    }

                    if (items.length === 0) {
                        return [
                            { id: 'root', name: 'Root', type: 'folder', parentId: null, color: 'blue', createdAt: new Date() },
                            { id: '1', name: 'Notion Ë™™Êòé', type: 'journal', parentId: 'root', content: 'Notion ÈÄ£ÁµêÊàêÂäüÔºÅ', createdAt: new Date() }
                        ];
                    }

                    return items;

                } catch (error) {
                    console.error("Notion getItems error", error);
                    // Fallback to defaults or empty to prevent crashing
                    return [];
                }
            }

            async saveItems(items) {
                // Full sync logic goes here (Updating pages, deleting, creating)
                console.log('Notion Sync triggered', items);
                // Due to Notion's API, this requires batch processing.
                return true;
            }

            async uploadFile(fileItem) {
                // Notion API doesn't support file hosting. 
                // We'd rely on a secondary host or Base64 (too large).
                return fileItem;
            }

            async deleteFile(item) {
                // Delete a block or archive a page
                if (item.id !== 'root') {
                    await this.notionRequest(`/pages/${item.id}`, 'PATCH', { archived: true });
                }
                return true;
            }
        }


        const app = {
            state: {
                items: [],
                currentFolder: 'root',
                viewMode: 'grid',
                editingId: null,
                contextId: null,
                searchQuery: '',
                providerName: 'local',
                moveTargetFolderId: null
            },

            storage: null,
            providers: {
                local: new LocalStorageProvider(),
                dropbox: new DropboxProvider('vwm80suenwqp1kc'),
                notion: new NotionProvider()
            },

            async init() {
                // Check for App Lock
                if (this.isAppLocked()) {
                    this.showLoginScreen();
                    return; // Wait for login
                }

                await this.startApp();
            },

            async startApp() {
                document.getElementById('login-overlay').style.display = 'none';

                // Check URL for auth redirect
                if (window.location.hash.includes('access_token')) {
                    this.state.providerName = 'dropbox';
                } else {
                    this.state.providerName = localStorage.getItem('nfm_provider') || 'local';
                }

                await this.switchProvider(this.state.providerName, false);
                this.setupEventListeners();
                console.log('NFM Dashboard Initialized');
            },

            // --- App Lock Logic ---
            isAppLocked() {
                // If password exists, assume locked on init
                return !!localStorage.getItem('nfm_app_password');
            },

            showLoginScreen() {
                const overlay = document.getElementById('login-overlay');
                const title = document.getElementById('login-title');
                const input = document.getElementById('login-input');

                overlay.style.display = 'flex';
                input.value = '';
                input.focus();

                if (!localStorage.getItem('nfm_app_password')) {
                    // Setup Mode
                    title.innerText = 'Ë®≠ÂÆö App ÂØÜÁ¢º';
                    input.placeholder = 'Ë®≠ÂÆöÊñ∞ÂØÜÁ¢º';
                    document.getElementById('login-msg').innerText = 'ÂàùÊ¨°‰ΩøÁî®ÔºåË´ãË®≠ÂÆö‰∏ÄÁµÑÂØÜÁ¢º';
                } else {
                    // Login Mode
                    title.innerText = 'Ëº∏ÂÖ•ÂØÜÁ¢ºËß£Èéñ';
                    input.placeholder = '‚Ä¢‚Ä¢‚Ä¢‚Ä¢';
                    document.getElementById('login-msg').innerText = '';
                }
            },

            checkLogin() {
                const input = document.getElementById('login-input');
                const pwd = input.value;
                const msg = document.getElementById('login-msg');

                if (!pwd) {
                    msg.innerText = 'Ë´ãËº∏ÂÖ•ÂØÜÁ¢º';
                    return;
                }

                const savedPwd = localStorage.getItem('nfm_app_password');

                if (!savedPwd) {
                    // Set new password
                    localStorage.setItem('nfm_app_password', pwd); // Warning: Plaintext for demo
                    this.startApp();
                    this.showToast('ÂØÜÁ¢ºÂ∑≤Ë®≠ÂÆö');
                } else {
                    // Verify
                    if (pwd === savedPwd) {
                        this.startApp();
                    } else {
                        msg.innerText = 'ÂØÜÁ¢ºÈåØË™§';
                        input.value = '';
                        input.classList.add('shake'); // Optional animation
                        setTimeout(() => input.classList.remove('shake'), 500);
                    }
                }
            },

            lockApp() {
                document.getElementById('settings-modal').style.display = 'none';
                document.getElementById('login-overlay').style.display = 'flex';
                document.getElementById('login-title').innerText = 'App Â∑≤ÈéñÂÆö';
                document.getElementById('login-input').value = '';
            },

            async switchProvider(name, reload = true) {
                this.state.providerName = name;
                this.storage = this.providers[name];
                localStorage.setItem('nfm_provider', name);

                // Specific init logic
                const isReady = await this.storage.init();

                if (name === 'dropbox' && !isReady) {
                    // Need login
                    if (confirm('ÈúÄË¶ÅÁôªÂÖ• DropboxÔºåÊòØÂê¶ÂâçÂæÄÔºü')) {
                        this.providers.dropbox.login();
                    } else {
                        // Fallback
                        this.switchProvider('local');
                    }
                    return;
                }

                this.loadData();
                this.updateSettingsUI();
                if (reload) this.showToast(`Â∑≤ÂàáÊèõËá≥ ${name}`);
                document.getElementById('settings-modal').style.display = 'none';
            },

            updateSettingsUI() {
                const status = document.getElementById('dropbox-status');
                const disconnectBtn = document.getElementById('btn-disconnect-dropbox');

                if (this.providers.dropbox.accessToken) {
                    status.innerText = 'Dropbox: Â∑≤ÈÄ£Áµê';
                    status.style.color = '#27c93f';
                    disconnectBtn.style.display = 'flex';
                } else {
                    status.innerText = 'Dropbox: Êú™ÈÄ£Áµê';
                    status.style.color = '';
                    disconnectBtn.style.display = 'none';
                }

                document.getElementById('btn-use-local').classList.toggle('primary', this.state.providerName === 'local');
                document.getElementById('btn-use-dropbox').classList.toggle('primary', this.state.providerName === 'dropbox');
            },

            toggleSettings() {
                this.updateSettingsUI();
                document.getElementById('settings-modal').style.display = 'flex';
            },

            async loadData() {
                try {
                    this.state.items = await this.storage.getItems();

                    // Fix date objects restoration
                    this.state.items.forEach(i => {
                        i.createdAt = new Date(i.createdAt);
                        if (i.updatedAt) i.updatedAt = new Date(i.updatedAt);
                    });

                    this.render();
                } catch (e) {
                    console.error('Load failed', e);
                    this.showToast('ËºâÂÖ•Â§±Êïó');
                }
            },

            async saveData() {
                try {
                    await this.storage.saveItems(this.state.items);
                } catch (e) {
                    console.error('Save failed', e);
                    this.showToast('ÂÑ≤Â≠òÂ§±Êïó (Ë´ãÊ™¢Êü•Á∂≤Ë∑ØÊàñÂÆπÈáè)');
                }
            },

            render() {
                this.renderBreadcrumbs();
                this.renderItems();
                this.renderFolderTree();
            },

            renderItems() {
                const grid = document.getElementById('items-grid');
                grid.className = `items-container ${this.state.viewMode}-view`;
                grid.innerHTML = '';

                let filteredItems = this.state.items.filter(item => {
                    // Exclude root and filter by current folder
                    if (item.id === 'root') return false;

                    const matchesFolder = item.parentId === this.state.currentFolder;
                    const query = this.state.searchQuery.toLowerCase();
                    const matchesSearch = item.name.toLowerCase().includes(query) ||
                        (item.tags && item.tags.some(t => t.toLowerCase().includes(query)));

                    return matchesFolder && matchesSearch;
                });

                if (filteredItems.length === 0) {
                    grid.innerHTML = `<div style="grid-column: 1/-1; text-align: center; opacity: 0.4; padding: 50px;">Ê≠§Ë≥áÊñôÂ§æÁõÆÂâçÊòØÁ©∫ÁöÑ</div>`;
                    return;
                }

                filteredItems.forEach(item => {
                    const card = document.createElement('div');
                    card.className = 'item-card glass-card';
                    card.oncontextmenu = (e) => this.showContextMenu(e, item.id);
                    card.onclick = () => this.handleItemClick(item);

                    // Drag and Drop
                    card.draggable = true;
                    card.ondragstart = (e) => {
                        e.dataTransfer.setData('text/plain', item.id);
                        e.stopPropagation();
                    };

                    if (item.type === 'folder') {
                        card.ondragover = (e) => {
                            e.preventDefault();
                            card.style.transform = 'scale(1.05)';
                            card.style.border = '1px solid var(--primary)';
                        };
                        card.ondragleave = (e) => {
                            card.style.transform = '';
                            card.style.border = '';
                        };
                        card.ondrop = (e) => {
                            e.preventDefault();
                            card.style.transform = '';
                            card.style.border = '';
                            const draggedId = e.dataTransfer.getData('text/plain');
                            app.handleMoveItem(draggedId, item.id);
                            e.stopPropagation();
                        };
                    }

                    let icon = 'fa-file-lines';
                    let colorStyle = '';

                    if (item.type === 'folder') {
                        icon = 'fa-folder';
                        colorStyle = `color: var(--folder-${item.color || 'blue'})`;
                    } else if (item.type === 'journal') {
                        icon = 'fa-book';
                        colorStyle = 'color: #ffbd2e';
                    }

                    let tagsHtml = '';
                    if (item.tags && item.tags.length > 0) {
                        tagsHtml = `<div class="item-tags" style="margin-top: 8px; display: flex; gap: 4px; flex-wrap: wrap; justify-content: center;">
                            ${item.tags.map(t => `<span style="background: rgba(255,255,255,0.15); padding: 2px 6px; border-radius: 4px; font-size: 0.65rem;">${t}</span>`).join('')}
                        </div>`;
                    }

                    let tagsHtmlList = '';
                    if (item.tags && item.tags.length > 0) {
                        tagsHtmlList = `<div class="item-tags" style="display: flex; gap: 4px; flex-wrap: wrap;">
                            ${item.tags.map(t => `<span style="background: rgba(255,255,255,0.15); padding: 2px 6px; border-radius: 4px; font-size: 0.65rem;">${t}</span>`).join('')}
                        </div>`;
                    }

                    if (this.state.viewMode === 'grid') {
                        card.innerHTML = `
                                <i class="fas ${icon}" style="${colorStyle}"></i>
                                <div class="item-name">${item.name}</div>
                                <div class="item-info">${new Date(item.createdAt).toLocaleDateString()}</div>
                                ${tagsHtml}
                            `;
                    } else {
                        // For list view, let's append tags to item-name area or a new column
                        card.innerHTML = `
                                <i class="fas ${icon}" style="${colorStyle}"></i>
                                <div style="display: flex; flex-direction: column; overflow: hidden;">
                                    <div class="item-name">${item.name}</div>
                                    ${tagsHtmlList}
                                </div>
                                <div class="item-info">${item.type === 'folder' ? 'Ë≥áÊñôÂ§æ' : (item.type === 'journal' ? 'Êó•Ë™å' : 'Ê™îÊ°à')}</div>
                                <div class="item-info">${new Date(item.createdAt).toLocaleString()}</div>
                                <div class="item-info">${item.fileSize ? (item.fileSize / 1024).toFixed(1) + ' KB' : '-'}</div>
                            `;
                    }

                    grid.appendChild(card);
                });
            },

            renderBreadcrumbs() {
                const container = document.getElementById('breadcrumbs');
                container.innerHTML = '';

                let path = [];
                let curr = this.state.items.find(i => i.id === this.state.currentFolder);

                while (curr) {
                    path.unshift(curr);
                    curr = this.state.items.find(i => i.id === curr.parentId);
                }

                path.forEach((p, idx) => {
                    const span = document.createElement('span');
                    span.innerText = p.id === 'root' ? 'üóÇ Ê™îÊ°àÁ∏ΩÁÆ°' : p.name;
                    span.onclick = () => this.navigateTo(p.id);
                    container.appendChild(span);
                    if (idx < path.length - 1) {
                        const sep = document.createTextNode(' / ');
                        container.appendChild(sep);
                    }
                });
            },

            renderFolderTree() {
                const container = document.getElementById('folder-tree');
                container.innerHTML = '';

                const folders = this.state.items.filter(i => i.type === 'folder' && i.id !== 'root');
                folders.forEach(f => {
                    const div = document.createElement('div');
                    div.className = `tree-item ${this.state.currentFolder === f.id ? 'active' : ''}`;
                    div.innerHTML = `<i class="fas fa-folder" style="color: var(--folder-${f.color})"></i> ${f.name}`;
                    div.onclick = () => this.navigateTo(f.id);

                    div.ondragover = (e) => {
                        e.preventDefault();
                        div.style.background = 'rgba(255, 255, 255, 0.2)';
                    };
                    div.ondragleave = (e) => {
                        div.style.background = '';
                    };
                    div.ondrop = (e) => {
                        e.preventDefault();
                        div.style.background = '';
                        const draggedId = e.dataTransfer.getData('text/plain');
                        app.handleMoveItem(draggedId, f.id);
                        e.stopPropagation();
                    };

                    container.appendChild(div);
                });
            },

            // --- Handlers ---
            handleMoveItem(itemId, targetFolderId) {
                if (!itemId || !targetFolderId) return;
                if (itemId === targetFolderId) return; // Cannot move into itself

                const item = this.state.items.find(i => i.id === itemId);
                if (!item) return;

                // Prevent moving a folder into its own children
                let currTarget = this.state.items.find(i => i.id === targetFolderId);
                while (currTarget && currTarget.id !== 'root') {
                    if (currTarget.id === itemId) {
                        this.showToast('ÁÑ°Ê≥ïÂ∞áË≥áÊñôÂ§æÁßªÂãïÂà∞ÂÖ∂Â≠êË≥áÊñôÂ§æ‰∏≠');
                        return;
                    }
                    currTarget = this.state.items.find(i => i.id === currTarget.parentId);
                }

                if (item.parentId === targetFolderId) return; // Already there

                item.parentId = targetFolderId;
                item.updatedAt = new Date();
                this.saveData();
                this.render();
                this.showToast('Â∑≤ÁßªÂãïÈ†ÖÁõÆ');
            },

            navigateTo(folderId) {
                this.state.currentFolder = folderId;
                this.state.searchQuery = '';
                document.getElementById('global-search').value = '';
                this.render();
            },

            handleItemClick(item) {
                if (item.type === 'folder') {
                    this.navigateTo(item.id);
                } else if (item.type === 'journal') {
                    this.openEditor(item.id);
                } else {
                    // File preview
                    if (item.fileData) {
                        // Local or Base64 cached
                        const win = window.open();
                        win.document.write('<iframe src="' + item.fileData + '" frameborder="0" style="border:0; top:0px; left:0px; bottom:0px; right:0px; width:100%; height:100%;" allowfullscreen></iframe>');
                    } else if (item.dropboxPath && this.state.providerName === 'dropbox') {
                        this.showToast('Ê≠£Âú®Âæû Dropbox ÂèñÂæóÈÄ£Áµê...');
                        this.providers.dropbox.dbx.filesGetTemporaryLink({ path: item.dropboxPath })
                            .then(response => {
                                window.open(response.result.link, '_blank');
                            })
                            .catch(err => {
                                console.error(err);
                                this.showToast('ÁÑ°Ê≥ïÈñãÂïüÊ™îÊ°à');
                            });
                    } else {
                        this.showToast('ÁÑ°Ê≥ïÈ†êË¶ΩÊ≠§Ê™îÊ°à');
                    }
                }
            },

            setViewMode(mode) {
                this.state.viewMode = mode;
                this.render();
            },

            toggleSettings() {
                const modal = document.getElementById('settings-modal');
                modal.style.display = modal.style.display === 'flex' ? 'none' : 'flex';
                // Update select element state
                document.getElementById('provider-select').value = this.state.providerName;

                // Show/hide Dropbox disconnect button
                const btnDisconnect = document.getElementById('btn-disconnect-dropbox');
                if (this.state.providerName === 'dropbox' && this.providers.dropbox.accessToken) {
                    btnDisconnect.style.display = 'block';
                } else {
                    btnDisconnect.style.display = 'none';
                }
            },

            createItem(type) {
                const name = prompt(`Ëº∏ÂÖ•${type === 'folder' ? 'Ë≥áÊñôÂ§æ' : 'Êó•Ë™å'}ÂêçÁ®±:`, `Êñ∞${type === 'folder' ? 'Ë≥áÊñôÂ§æ' : 'Êó•Ë™å'}`);
                if (!name) return;

                const newItem = {
                    id: 'nfm_' + Date.now(),
                    name: name,
                    type: type,
                    parentId: this.state.currentFolder,
                    color: 'blue',
                    content: '',
                    createdAt: new Date(),
                    updatedAt: new Date()
                };

                this.state.items.push(newItem);
                this.saveData();
                this.render();
                this.showToast('Â∑≤Âª∫Á´ã');
            },

            handleFileUpload(files) {
                Array.from(files).forEach(file => {
                    const fileItem = {
                        id: 'file_' + Date.now() + Math.random(),
                        name: file.name,
                        type: 'file',
                        parentId: this.state.currentFolder,
                        fileSize: file.size,
                        fileType: file.type,
                        createdAt: new Date()
                    };

                    // We need to keep the file object for upload
                    fileItem.fileObj = file;

                    // For local preview immediately if small
                    const reader = new FileReader();
                    reader.onload = async (e) => {
                        // Only cache small files base64 for local storage to avoid quota exceed
                        if (this.state.providerName === 'local' && file.size < 2000000) {
                            fileItem.fileData = e.target.result;
                        }

                        try {
                            const processedItem = await this.storage.uploadFile(fileItem);
                            this.state.items.push(processedItem);
                            this.saveData();
                            this.render();
                            this.showToast(`ÊàêÂäü‰∏äÂÇ≥ ${file.name}`);
                        } catch (err) {
                            this.showToast(`‰∏äÂÇ≥Â§±Êïó ${file.name}`);
                        }
                    };
                    reader.readAsDataURL(file);
                });
            },

            // --- Editor ---
            openEditor(id) {
                const item = this.state.items.find(i => i.id === id);
                this.state.editingId = id;
                document.getElementById('editor-title').value = item.name;
                document.getElementById('editor-body').innerHTML = item.content || '';
                document.getElementById('editor-meta').innerText = `ÊúÄÂæåÊõ¥Êñ∞: ${new Date(item.updatedAt || item.createdAt).toLocaleString()}`;

                document.getElementById('journal-modal').style.display = 'flex';
            },

            closeEditor() {
                const id = this.state.editingId;
                const item = this.state.items.find(i => i.id === id);

                item.name = document.getElementById('editor-title').value || 'ÁÑ°Ê®ôÈ°å';
                item.content = document.getElementById('editor-body').innerHTML;
                item.updatedAt = new Date();

                this.saveData();
                this.state.editingId = null;
                document.getElementById('journal-modal').style.display = 'none';
                this.render();
                this.showToast('Â∑≤Ëá™ÂãïÂÑ≤Â≠ò');
            },

            // --- Context Menu Actions ---
            showContextMenu(e, id) {
                e.preventDefault();
                this.state.contextId = id;
                const menu = document.getElementById('context-menu');
                menu.style.display = 'block';
                menu.style.left = e.pageX + 'px';
                menu.style.top = e.pageY + 'px';

                // Only show color picker for folders
                const item = this.state.items.find(i => i.id === id);
                document.getElementById('folder-colors').style.display = item.type === 'folder' ? 'flex' : 'none';
            },

            hideContextMenu() {
                document.getElementById('context-menu').style.display = 'none';
            },

            showTagsModal() {
                const item = this.state.items.find(i => i.id === this.state.contextId);
                if (!item) return;

                if (!item.tags) item.tags = [];

                this.renderTagsModal(item);
                document.getElementById('tag-input').value = '';
                document.getElementById('tags-modal').style.display = 'flex';
                this.hideContextMenu();
            },

            renderTagsModal(item) {
                const container = document.getElementById('current-tags');
                container.innerHTML = '';
                if (item.tags.length === 0) {
                    container.innerHTML = '<span style="opacity:0.5; font-size: 0.8rem;">Â∞öÁÑ°Ê®ôÁ±§ÔºåË´ãÊñº‰∏äÊñπËº∏ÂÖ•Êñ∞Â¢û</span>';
                    return;
                }
                item.tags.forEach(tag => {
                    const el = document.createElement('span');
                    el.style.cssText = "background: rgba(255,255,255,0.2); padding: 4px 10px; border-radius: 12px; font-size: 0.8rem; display: flex; align-items: center; gap: 5px;";
                    el.innerHTML = `${tag} <i class="fas fa-times" style="cursor:pointer;" onclick="app.removeTag('${tag}')"></i>`;
                    container.appendChild(el);
                });
            },

            addTag(val) {
                const tag = val.trim();
                if (!tag) return;
                const item = this.state.items.find(i => i.id === this.state.contextId);
                if (!item.tags) item.tags = [];
                if (!item.tags.includes(tag)) {
                    item.tags.push(tag);
                    item.updatedAt = new Date();
                    this.saveData();
                    this.render();
                }
                document.getElementById('tag-input').value = '';
                this.renderTagsModal(item);
            },

            removeTag(tag) {
                const item = this.state.items.find(i => i.id === this.state.contextId);
                if (item && item.tags) {
                    item.tags = item.tags.filter(t => t !== tag);
                    item.updatedAt = new Date();
                    this.saveData();
                    this.render();
                    this.renderTagsModal(item);
                }
            },

            showMoveModal() {
                const item = this.state.items.find(i => i.id === this.state.contextId);
                if (!item) return;

                this.state.moveTargetFolderId = null;
                const modal = document.getElementById('move-modal');
                const list = document.getElementById('move-folder-list');
                list.innerHTML = '';

                // Add root
                this.appendMoveFolderOption('root', 'üè† Ê†πÁõÆÈåÑ', 0);

                // Add all other folders recursively or just flat
                const folders = this.state.items.filter(i => i.type === 'folder' && i.id !== 'root');
                folders.forEach(f => {
                    this.appendMoveFolderOption(f.id, `üìÅ ${f.name}`, 0);
                });

                modal.style.display = 'flex';
                this.hideContextMenu();
            },

            appendMoveFolderOption(id, label, depth) {
                const div = document.createElement('div');
                div.className = 'tree-item';
                div.style.paddingLeft = `${12 + depth * 15}px`;
                div.innerText = label;
                div.onclick = () => {
                    Array.from(document.getElementById('move-folder-list').children).forEach(c => c.classList.remove('active'));
                    div.classList.add('active');
                    this.state.moveTargetFolderId = id;
                };
                document.getElementById('move-folder-list').appendChild(div);
            },

            confirmMove() {
                if (!this.state.moveTargetFolderId) {
                    this.showToast('Ë´ãÂÖàÈÅ∏ÊìáÁõÆÊ®ôË≥áÊñôÂ§æ');
                    return;
                }
                this.handleMoveItem(this.state.contextId, this.state.moveTargetFolderId);
                document.getElementById('move-modal').style.display = 'none';
            },

            async deleteItem() {
                if (confirm('Á¢∫ÂÆöË¶ÅÂà™Èô§Ê≠§È†ÖÁõÆÂóéÔºü')) {
                    const itemToDelete = this.state.items.find(i => i.id === this.state.contextId);
                    if (itemToDelete) {
                        if (this.storage.deleteFile) {
                            await this.storage.deleteFile(itemToDelete);
                        }
                        this.state.items = this.state.items.filter(i => i.id !== this.state.contextId);
                        this.saveData();
                        this.render();
                        this.showToast('Â∑≤Âà™Èô§');
                    }
                }
                this.hideContextMenu();
            },

            renameItem() {
                const item = this.state.items.find(i => i.id === this.state.contextId);
                const newName = prompt('Ë´ãËº∏ÂÖ•Êñ∞ÂêçÁ®±:', item.name);
                if (newName) {
                    item.name = newName;
                    this.saveData();
                    this.render();
                }
                this.hideContextMenu();
            },

            setItemColor(color) {
                const item = this.state.items.find(i => i.id === this.state.contextId);
                item.color = color;
                this.saveData();
                this.render();
                this.hideContextMenu();
            },

            shareItem() {
                const url = window.location.href + '#share=' + this.state.contextId;
                navigator.clipboard.writeText(url);
                this.showToast('ÂàÜ‰∫´ÈÄ£ÁµêÂ∑≤Ë§áË£ΩÂà∞Ââ™Ë≤ºÁ∞ø');
                this.hideContextMenu();
            },

            search(val) {
                this.state.searchQuery = val;
                this.render();
            },

            setupEventListeners() {
                document.addEventListener('click', () => this.hideContextMenu());

                // Drag and Drop
                const main = document.getElementById('main-content');
                const dropZone = document.getElementById('drop-zone');

                window.addEventListener('dragover', (e) => {
                    e.preventDefault();
                    dropZone.style.display = 'flex';
                });

                dropZone.addEventListener('dragleave', () => {
                    dropZone.style.display = 'none';
                });

                dropZone.addEventListener('drop', (e) => {
                    e.preventDefault();
                    dropZone.style.display = 'none';
                    this.handleFileUpload(e.dataTransfer.files);
                });
            },

            showToast(msg) {
                const t = document.getElementById('toast');
                t.innerText = msg;
                t.style.display = 'block';
                setTimeout(() => t.style.display = 'none', 3000);
            }
        };

        app.init();
    </script>
</body>

</html>